@page "/application"

@using System.ComponentModel.DataAnnotations
@using BlazorFlow.Helpers
@using BlazorFlow.Models
@using BlazorFlow.Services
@using BlazorFlow.Shared.Components

@inject NavigationManager NavigationManager
@inject FlowService FlowService
@inject FlowNodeService FlowNodeService
@inject FlowLinkService FlowLinkService

<h1>Flow</h1>

@if (CurrentNode is null)
{
    <p><em>Loading...</em></p>
}
else
{
<EditForm Model="@PageModel" OnValidSubmit="Next">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div id="question">
        <p>@CurrentNode.FlowQuestion.FlowQuestionTextEn</p>
    </div>

    <div id="answer">
        @if (CurrentNode.FlowNodeType == FlowValueType.Radio)
        {
            if (CurrentNode.FlowAnswers is {} flowAnswers)
            {
                @foreach (var answer in flowAnswers)
                {
                    <label class="radio-answer">
                        <InputRadio name="radio" SelectedValue="answer.FlowAnswerValue" @bind-Value="PageModel.StringValue" />
                        @answer.FlowAnswerTextEn
                    </label>
                }
            }
        }
        else if (CurrentNodeType == FlowValueType.Select)
        {
            if (CurrentNode.FlowAnswers is {} flowAnswers)
            {
                <InputSelect @bind-Value="PageModel.StringValue">
                    <option value="">Select...</option>
                    @foreach (var answer in flowAnswers)
                    {
                        <option value="@answer.FlowAnswerValue">@answer.FlowAnswerTextEn</option>
                    }
                </InputSelect>
            }
            else if (CurrentNode.FlowNodeEntity is {} flowNodeEntity && PageModel.LookupValues is {} lookup)
            {
                <InputSelect @bind-Value="PageModel.StringValue">
                    <option value="">Select...</option>
                    @foreach (var value in lookup)
                    {
                        <option value="@value.Key">@value.Value</option>
                    }
                </InputSelect>
            }
        }
        else if (CurrentNode.FlowNodeType == FlowValueType.Number)
        {
            <InputNumber @bind-Value="PageModel.NumberValue" />
        }
        else if (CurrentNode.FlowNodeType == FlowValueType.Checkbox)
        {
            if (CurrentNode.FlowAnswers is {} flowAnswers)
            {
                @foreach (var answer in flowAnswers)
                {
                    <label class="checkbox-answer">
                        <input type="checkbox" name="checkbox" checked="@CheckboxIsChecked(answer.FlowAnswerValue)" @onchange="@((e) => CheckboxChanged(answer.FlowAnswerValue, e))" />
                        @answer.FlowAnswerTextEn
                    </label>
                }
            }
        }
        else if (CurrentNodeType == FlowValueType.DateTime)
        {
            <InputDate @bind-Value="PageModel.DateTimeValue" />
        }
        else if (CurrentNodeType == FlowValueType.Text)
        {
            <InputText @bind-Value="PageModel.StringValue" />
        }
        else if (CurrentNodeType == FlowValueType.TextArea)
        {
            <InputTextArea @bind-Value="PageModel.StringValue" />
        }
    </div>

    <div id="navigation" class="row">
        <button class="btn btn-primary" @onclick="Previous" disabled="@isFirstNode">Previous</button>
        <button class="btn btn-primary" type="submit">Next</button>
    </div>
</EditForm>
}

@code {
    Flow CurrentFlow = null!;
    FlowNode? CurrentNode;
    FlowValueType? CurrentNodeType => CurrentNode?.FlowNodeType;
    FlowNodeEntity? CurrentNodeEntity => CurrentNode?.FlowNodeEntity;
    FlowLink[]? CurrentLinks => CurrentNode is null ? new FlowLink[0] : CurrentFlow.OutEdges(CurrentNode!).ToArray();
    UserFlow CurrentUserFlow = null!;
    LinkedListNode<UserFlowAnswer>? CurrentUserFlowAnswer;

    bool isFirstNode => CurrentFlow.Edges.All(l => l.Target != CurrentNode);
    bool isLastNode => CurrentFlow.IsOutEdgesEmpty(CurrentNode!);

    Model PageModel = new Model();

    protected override async Task OnInitializedAsync()
    {
        var flow = await FlowService.GetFlow(1);
        var flowId = flow.FlowId;
        var nodes = await FlowNodeService.GetFlowNodes(flowId);
        var links = await FlowLinkService.GetFlowLinks(flowId); // conditions not populating

        if (flow is {} existingFlow) {
            CurrentFlow = existingFlow;
        }
        else {
            throw new Exception();
        }

        if (nodes is {} existingNodes && existingNodes.Any())
        {
            CurrentFlow.AddVertexRange(existingNodes);
        }

        if (links is {} existingLinks && existingLinks.Any())
        {
            CurrentFlow.AddEdgeRange(existingLinks);
        }

        CurrentNode = CurrentFlow.Vertices.First(x => x.FlowQuestion.FlowQuestionCode == "START"); // To use algorithm instead of hard coding

        CurrentUserFlow = new UserFlow();

        SetModel();
    }

    void Next()
    {
        SaveAnswer();
        var appointedLink = EvaluateLinks();
        // if no links, we're at the end
        // NavigationManager.NavigateTo("/");
        CurrentNode = appointedLink.Target;
        SetModel();
    }

    void Previous()
    {
        // User has answered this question before, so there should be an answer that targets this node
        var prevUserFlowAnswerId = CurrentUserFlow.UserFlowAnswers.Nodes().FirstOrDefault(ufa => ufa.Next?.Value.FlowNodeId == CurrentNode?.FlowNodeId)?.Value.FlowNodeId;
        // User hasn't answered this question yet, therefore the previous answer target is still null, so use the last answer that isn't stale
        prevUserFlowAnswerId ??= CurrentUserFlow.UserFlowAnswers.Nodes().Where(ufa => ufa.Value.IsStale == false).Last().Value.FlowNodeId;

        CurrentNode = CurrentFlow.Vertices.First(n => n.FlowNodeId == prevUserFlowAnswerId);
        SetModel();
        StateHasChanged();
    }

    bool CheckboxIsChecked(string flowAnswerValue)
    {
        return PageModel.CheckboxValues?.Contains(flowAnswerValue) ?? false;
    }

    // To be improved
    void CheckboxChanged(string checkboxValue, ChangeEventArgs e)
    {
        PageModel.CheckboxValues ??= new HashSet<string>();
        var isChecked = (bool)e.Value;

        if (isChecked && !PageModel.CheckboxValues.Contains(checkboxValue))
        {
            PageModel.CheckboxValues.Add(checkboxValue);
        }
        else if (!isChecked && PageModel.CheckboxValues.Contains(checkboxValue))
        {
            PageModel.CheckboxValues.Remove(checkboxValue);
        }
    }

    void SaveAnswer()
    {
        // To be improved
        List<string> newAnswerValue() => CurrentNodeType switch
        {
            FlowValueType.Radio => new List<string> { PageModel.StringValue! },
            FlowValueType.Select => new List<string> { PageModel.StringValue! },
            FlowValueType.Number => new List<string> { PageModel.NumberValue.ToString()! },
            FlowValueType.Checkbox => PageModel.CheckboxValues.ToList(),
            FlowValueType.DateTime => new List<string> { PageModel.DateTimeValue.ToString()! },
            FlowValueType.Text => new List<string> { PageModel.StringValue! },
            FlowValueType.TextArea => new List<string> { PageModel.StringValue! },
            _ => new List<string>()
        };

        if (CurrentUserFlowAnswer is {} existing)
        {
            if (existing.Value.UserFlowAnswerValue != newAnswerValue())
            {
                CurrentUserFlowAnswer.Value.UserFlowAnswerValue = newAnswerValue();
                CurrentUserFlowAnswer.Value.IsStale = false;
            }

            // Set all subsequent userFlowAnswers as stale
            var nextUserFlowAnswer = CurrentUserFlowAnswer.Next;

            while (nextUserFlowAnswer is {} alsoExisting)
            {
                nextUserFlowAnswer.Value.IsStale = true;
                nextUserFlowAnswer = nextUserFlowAnswer.Next;
            }
        }
        else
        {
            CurrentUserFlowAnswer = new LinkedListNode<UserFlowAnswer>(new UserFlowAnswer(CurrentNode!.FlowNodeId, newAnswerValue()));

            if (CurrentUserFlow.UserFlowAnswers.Any())
            {
                var lastUserFlowAnswer = CurrentUserFlow.UserFlowAnswers.Last!;
                CurrentUserFlow.UserFlowAnswers.AddAfter(lastUserFlowAnswer, CurrentUserFlowAnswer);
            }
            else
            {
                CurrentUserFlow.UserFlowAnswers.AddFirst(CurrentUserFlowAnswer);
            }
        }
    }

    FlowLink EvaluateLinks()
    {
        if (CurrentLinks?.Length == 0)
        {
            throw new NotImplementedException();
        }
        else if (CurrentLinks?.Length == 1)
        {
            return CurrentLinks.First();
        }
        else
        {
            var availableLinks = new List<FlowLink>();

            // To be improved; no condition means automatic pass
            foreach (var link in CurrentLinks!)
            {
                if (CurrentNodeType == FlowValueType.Radio || CurrentNodeType == FlowValueType.Select)
                {
                    //if (link.FlowCondition?.Evaluate(PageModel.StringValue) ?? true)
                    if (link.IsAvailable(PageModel.StringValue!))
                    {
                        availableLinks.Add(link);
                    }
                }
                else if (CurrentNodeType == FlowValueType.Number)
                {
                    //if (link.FlowCondition?.Evaluate(PageModel.NumberValue) ?? true)
                    if (link.IsAvailable(PageModel.NumberValue!))
                    {
                        availableLinks.Add(link);
                    }
                }
                else if (CurrentNodeType == FlowValueType.Checkbox)
                {
                    //if (link.FlowCondition?.Evaluate(PageModel.CheckboxValues) ?? true)
                    //{
                        //availableLinks.Add(link);
                    //}
                }
                else if (CurrentNodeType == FlowValueType.DateTime)
                {
                    //if (link.FlowCondition?.Evaluate(PageModel.DateTimeValue) ?? true)
                    if (link.IsAvailable(PageModel.DateTimeValue))
                    {
                        availableLinks.Add(link);
                    }
                }
            }

            if (availableLinks.Count > 1)
            {
                // Go to link with condition since no condition is catch-all
                return availableLinks.First(l => l.FlowConditions != null);
            }
            else
            {
                return availableLinks.First();
            }
        }
    }

    // To be improved
    void SetModel()
    {
        if (CurrentNodeEntity is {} entity && entity != FlowNodeEntity.None)
        {
            PageModel.LookupValues = LookupService.GetLookup(entity);
        }
        else
        {
            PageModel.LookupValues?.Clear();
        }

        CurrentUserFlowAnswer = CurrentUserFlow.UserFlowAnswers.Nodes().FirstOrDefault(x => x.Value.FlowNodeId == CurrentNode!.FlowNodeId);

        if (CurrentUserFlowAnswer is { Value: var userFlowAnswer } existing)
        {
            if (CurrentNodeType == FlowValueType.Radio || CurrentNodeType == FlowValueType.Select)
            {
                PageModel.StringValue = userFlowAnswer?.UserFlowAnswerValue?.FirstOrDefault() ?? string.Empty;
            }
            else if (CurrentNodeType == FlowValueType.Number)
            {
                var parsed = Decimal.TryParse(userFlowAnswer?.UserFlowAnswerValue?.FirstOrDefault(), out var result);

                if (parsed)
                {
                    PageModel.NumberValue = result;
                }
            }
            else if (CurrentNodeType == FlowValueType.Checkbox)
            {
                var hashSet = new HashSet<string>(userFlowAnswer.UserFlowAnswerValue!);
                PageModel.CheckboxValues = hashSet;
            }
            else if (CurrentNodeType == FlowValueType.DateTime)
            {
                var parsed = DateTime.TryParse(userFlowAnswer?.UserFlowAnswerValue?.FirstOrDefault(), out var result);

                if (parsed)
                {
                    PageModel.DateTimeValue = result;
                }
            }
            else if (CurrentNodeType == FlowValueType.Text || CurrentNodeType == FlowValueType.TextArea)
            {
                PageModel.StringValue = userFlowAnswer?.UserFlowAnswerValue?.FirstOrDefault() ?? string.Empty;
            }
        }
        else
        {
            PageModel.StringValue = string.Empty;
            PageModel.NumberValue = default(decimal);
            PageModel.CheckboxValues?.Clear();
            PageModel.DateTimeValue = default(DateTime);
        }
    }

    // To add validation
    public class Model
    {
        public string? StringValue { get; set; }

        public decimal? NumberValue { get; set; }

        public HashSet<string>? CheckboxValues { get; set; }

        // Nullable DateTimes not supported; broken in Safari
        public DateTime DateTimeValue { get; set; }

        public Dictionary<string, string>? LookupValues { get; set; }
    }
}

<style>
    button {
        margin-left: 0.5em;
    }

    input, textarea, select {
        margin-bottom: 1em;
    }

    .radio-answer, .checkbox-answer {
        display: block;
    }
</style>
